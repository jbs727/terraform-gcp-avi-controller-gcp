---
- hosts: localhost
  connection: local
  gather_facts: no
  collections:
    - vmware.alb
  vars:
    avi_credentials:
        controller: "{{ controller_ip }}"
        username: "admin"
        password: "{{ password }}"
        api_version: "{{ avi_version }}"
    cloud_name: "Default-Cloud"
    controller_ha: "{{ controller_ha }}"
    se_name_prefix: "{{ name_prefix }}"
  tasks:
    - name: Get Cloud Info
      avi_api_session:
        avi_credentials: "{{ avi_credentials }}"
        http_method: get
        path: "cloud?name=Default-Cloud"
      retries: 10
      delay: 10
      register: avi_cloud

    - name: Print return information from the previous task
      ansible.builtin.debug:
        var: avi_cloud
    
    - name: Pause for Avi Controller to build Cluster
      pause:
        minutes: 10
      when: controller_ha | bool

    - name: Wait for Cloud status to be ready
      avi_api_session:
        avi_credentials: "{{ avi_credentials }}"
        http_method: get
        path: "cloud/{{ avi_cloud.obj.results.0.uuid }}/status"
      until: cloudstatus.obj.state == "CLOUD_STATE_PLACEMENT_READY"
      retries: 20
      delay: 30
      register: cloudstatus
    
    - name: Print return information from the previous task
      ansible.builtin.debug:
        var: cloudstatus

    - name: Get System Config Status
      avi_api_session:
        avi_credentials: "{{ avi_credentials }}"
        http_method: get
        path: "systemconfiguration"
      retries: 5
      delay: 10
      register: system_config

    - name: Test System Config
      fail:
        msg: The welcome workflow has not been completed successfully
      when: system_config.obj.welcome_workflow_complete != true

    - name: Print return information from the previous task
      ansible.builtin.debug:
        var: system_config
    
    - name: Get SE Group Config
      avi_api_session:
        avi_credentials: "{{ avi_credentials }}"
        http_method: get
        path: "serviceenginegroup?name=Default-Group"
      retries: 5
      delay: 10
      register: se_group_config

    - name: Test SE Group Config
      fail:
        msg: The SE Group configuration was not updated
      when: se_group_config.obj.results.0.ha_mode != "HA_MODE_SHARED_PAIR" or se_group_config.obj.results.0.se_name_prefix != se_name_prefix

    - name: Print return information from the previous task
      ansible.builtin.debug:
        var: se_group_config

    - name: Get Controller Cluster Status
      avi_api_session:
        avi_credentials: "{{ avi_credentials }}"
        http_method: get
        path: "cluster/runtime"
      until: cluster_runtime.obj.cluster_state.progress == 100 and cluster_runtime.obj.cluster_state.state == "CLUSTER_UP_HA_ACTIVE"
      retries: 20
      delay: 30
      register: cluster_runtime
      when: controller_ha | bool
    
    - name: Print return information from the previous task
      ansible.builtin.debug:
        var: cluster_runtime.obj.cluster_state
      when: controller_ha | bool